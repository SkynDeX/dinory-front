#########################################
# Dinory í”„ë¡ íŠ¸ì—”ë“œ CI/CD ì›Œí¬í”Œë¡œìš°
#
# ì´ íŒŒì¼ì€ í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œê°€ ë³€ê²½ë  ë•Œ ìë™ìœ¼ë¡œ:
# 1. React ì•±ì„ ë¹Œë“œí•˜ê³ 
# 2. Docker ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³ 
# 3. Docker Hubì— ì—…ë¡œë“œí•˜ê³ 
# 4. ì„œë²„ì— ë°°í¬í•©ë‹ˆë‹¤
#########################################

name: Frontend CI/CD

# ğŸ¯ ì–¸ì œ ì‹¤í–‰í• ê¹Œìš”?
on:
  push:
    branches:
      - main              # main ë¸Œëœì¹˜ì— pushí•  ë•Œ
      - develop           # develop ë¸Œëœì¹˜ì— pushí•  ë•Œ

  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

# ğŸ”§ ì‘ì—… ì •ì˜
jobs:
  build-and-deploy:
    name: ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest

    steps:
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 1: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 2: Node.js ì„¤ì •
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸŸ¢ Node.js 20 ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'          # Yarn ìºì‹œ ì‚¬ìš© (ë¹Œë“œ ì†ë„ í–¥ìƒ)

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 3: Docker ì„¤ì •
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸ³ Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 4: Docker Hub ë¡œê·¸ì¸
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸ” Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 5: Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/dinory-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 6: ì„œë²„ì— ë°°í¬
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ğŸš€ ì„œë²„ ë°°í¬ (ì¸ìŠ¤í„´ìŠ¤ #2)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.AI_SERVER_HOST }}      # 152.69.232.28
          username: ${{ secrets.AI_SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/${{ secrets.AI_SERVER_USERNAME }}/dinory

            # ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            docker pull ${{ secrets.DOCKER_USERNAME }}/dinory-frontend:latest

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            docker-compose -f docker-compose.instance2.yml stop frontend 2>/dev/null || true
            docker-compose -f docker-compose.instance2.yml rm -f frontend 2>/dev/null || true

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
            docker-compose -f docker-compose.instance2.yml up -d frontend

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ (10ì´ˆ ëŒ€ê¸° í›„)
            sleep 10
            docker-compose -f docker-compose.instance2.yml ps frontend

            # ë¡œê·¸ í™•ì¸ (ìµœê·¼ 20ì¤„)
            docker-compose -f docker-compose.instance2.yml logs --tail 20 frontend

            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 7: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: âœ… ë°°í¬ ì™„ë£Œ
        run: |
          echo "ğŸ‰ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“¦ ì´ë¯¸ì§€: ${{ secrets.DOCKER_USERNAME }}/dinory-frontend:latest"
          echo "ğŸ”— ì»¤ë°‹: ${{ github.sha }}"
